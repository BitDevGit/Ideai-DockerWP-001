# Flexible Multi-Site WordPress Development Environment
# Supports: Normal sites, Subdomain multisite, Subdirectory multisite
# Each top-level domain (site1.local, site2.local) has its own database
# All share wp-content (themes, plugins)

services:
  # Nginx - Routes all domains and subdomains
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/flexible-multisite.conf:/etc/nginx/conf.d/default.conf:ro
      # Optional HTTPS vhosts (empty by default; populated by scripts/dev/setup-https-mkcert.sh)
      - ./nginx/conf.d/https:/etc/nginx/conf.d/https:ro
      # Certificates (generated locally, not committed)
      - ./nginx/certs:/etc/nginx/certs:ro
      # Dashboard (subtree-ready module)
      - ./vendor/ideai-local-dev-dashboard/dashboard:/var/www/dashboard:ro
      - wp1_data:/var/www/site1:ro
      - wp2_data:/var/www/site2:ro
      - wp3_data:/var/www/site3:ro
      # Shared wp-content for static assets (themes/plugins)
      - ./wp-content:/var/www/shared-wp-content:ro
    depends_on:
      - wordpress1
      - wordpress2
      - wordpress3
    restart: unless-stopped
    networks:
      - wp-network

  # WordPress Site 1 (site1.local)
  # Can be configured as: Normal, Subdomain Multisite, or Subdirectory Multisite
  wordpress1:
    image: wordpress:6.4-php8.2-fpm
    volumes:
      - wp1_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - wp1_uploads:/var/www/html/wp-content/uploads
    environment:
      WORDPRESS_DB_HOST: db1:3306
      WORDPRESS_DB_USER: ${DB1_USER:-wordpress1}
      WORDPRESS_DB_PASSWORD: ${DB1_PASSWORD:-site1_password}
      WORDPRESS_DB_NAME: ${DB1_NAME:-wordpress1}
    depends_on:
      db1:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - wp-network

  # WordPress Site 2 (site2.local)
  # Can be configured as: Normal, Subdomain Multisite, or Subdirectory Multisite
  wordpress2:
    image: wordpress:6.4-php8.2-fpm
    volumes:
      - wp2_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - wp2_uploads:/var/www/html/wp-content/uploads
    environment:
      WORDPRESS_DB_HOST: db2:3306
      WORDPRESS_DB_USER: ${DB2_USER:-wordpress2}
      WORDPRESS_DB_PASSWORD: ${DB2_PASSWORD:-site2_password}
      WORDPRESS_DB_NAME: ${DB2_NAME:-wordpress2}
    depends_on:
      db2:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - wp-network

  # WordPress Site 3 (site3.local)
  # Intended demo target: Subdirectory Multisite
  wordpress3:
    image: wordpress:6.4-php8.2-fpm
    volumes:
      - wp3_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - wp3_uploads:/var/www/html/wp-content/uploads
    environment:
      WORDPRESS_DB_HOST: db3:3306
      WORDPRESS_DB_USER: ${DB3_USER:-wordpress3}
      WORDPRESS_DB_PASSWORD: ${DB3_PASSWORD:-site3_password}
      WORDPRESS_DB_NAME: ${DB3_NAME:-wordpress3}
    depends_on:
      db3:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - wp-network

  # Database for Site 1 (site1.local)
  # Shared by all subdomains/subdirectories if multisite
  db1:
    image: mariadb:10.11
    volumes:
      - db1_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB1_ROOT_PASSWORD:-root_site1_password}
      MYSQL_DATABASE: ${DB1_NAME:-wordpress1}
      MYSQL_USER: ${DB1_USER:-wordpress1}
      MYSQL_PASSWORD: ${DB1_PASSWORD:-site1_password}
    command: --default-authentication-plugin=mysql_native_password --innodb-buffer-pool-size=64M --max-connections=100
    restart: unless-stopped
    networks:
      - wp-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB1_ROOT_PASSWORD:-root_site1_password}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Database for Site 2 (site2.local)
  # Shared by all subdomains/subdirectories if multisite
  db2:
    image: mariadb:10.11
    volumes:
      - db2_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB2_ROOT_PASSWORD:-root_site2_password}
      MYSQL_DATABASE: ${DB2_NAME:-wordpress2}
      MYSQL_USER: ${DB2_USER:-wordpress2}
      MYSQL_PASSWORD: ${DB2_PASSWORD:-site2_password}
    command: --default-authentication-plugin=mysql_native_password --innodb-buffer-pool-size=64M --max-connections=100
    restart: unless-stopped
    networks:
      - wp-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB2_ROOT_PASSWORD:-root_site2_password}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Database for Site 3 (site3.local)
  # Shared by all subdirectories if multisite
  db3:
    image: mariadb:10.11
    volumes:
      - db3_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB3_ROOT_PASSWORD:-root_site3_password}
      MYSQL_DATABASE: ${DB3_NAME:-wordpress3}
      MYSQL_USER: ${DB3_USER:-wordpress3}
      MYSQL_PASSWORD: ${DB3_PASSWORD:-site3_password}
    command: --default-authentication-plugin=mysql_native_password --innodb-buffer-pool-size=64M --max-connections=100
    restart: unless-stopped
    networks:
      - wp-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB3_ROOT_PASSWORD:-root_site3_password}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  # Site 1 volumes
  wp1_data:
    driver: local
  wp1_uploads:
    driver: local
  db1_data:
    driver: local
  # Site 2 volumes
  wp2_data:
    driver: local
  wp2_uploads:
    driver: local
  db2_data:
    driver: local
  # Site 3 volumes
  wp3_data:
    driver: local
  wp3_uploads:
    driver: local
  db3_data:
    driver: local

networks:
  wp-network:
    driver: bridge

