# Nginx: Subdirectory multisite with nested paths (any depth)

This project supports WordPress multisite in **subdirectory** mode on `site3.localwp`, including **nested paths** like:

- `/sub1/wp-admin/`
- `/sub1/subsub1/wp-admin/`
- `/sub1/subsub1/subsubsub1/wp-admin/`

## Why nginx needs special rules

WordPress multisite (subdirectories) expects the web server to internally rewrite requests so that:

- `/any/site/prefix/wp-admin/...` is served by `/wp-admin/...`
- `/any/site/prefix/wp-includes/...` is served by `/wp-includes/...`
- `/any/site/prefix/wp-content/...` is served by `/wp-content/...`
- `/any/site/prefix/*.php` is served by `/*.php`

Without this, nested admin URLs often:
- 404
- redirect-loop
- or worse: serve PHP files as downloads if nginx locations are wrong.

## The rules we use (HTTPS local dev)

Generated by `scripts/dev/setup-https-mkcert.sh` for the Site 3 vhost:

- Match **any depth** `/(segment/)+` before a core WP path:
  - `wp-admin`, `wp-includes`, `wp-content`
- Rewrite internally to the core location.

Key pattern (any depth):

- `^/(?:[^/]+/)+...`

That means: one or more path segments ending in `/`.

## Important notes

- `location /wp-admin/` must **not** be `^~` or nginx may serve `wp-admin/index.php` as a static file (browser “downloads” it).
- PHP handling must be via the `location ~ \.php$` fastcgi block.



